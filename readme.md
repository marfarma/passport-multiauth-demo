## Demo - Using Passport to authenticate users with multiple auth methods

This is currently mostly working! If you log in for the first time with twitter
or google, the app suggest a username ('handle') based on the 3rd party profile.
It won't let you choose a username that already exists.

$ node app.js

$ firefox 127.0.0.1:3000

127.0.0.1:3000/ renders index.jade, providing the following:

* welcome message
* if logged in, options to link accounts
* if logged out, a form to log in with user/pass
* if logged out, links to start third party auth process
* form to create a new user with user/pass/pass
* list of user objects

Creating a new account with a google id asks the user halfway if they are
satisfied with an autogenerated handle; they can change it before the auth
process is complete.

Twitter works AS LONG AS you access the app with url 127.0.0.1:3000 instead of 
localhost:3000. This is because dev.twitter.com/apps/ provides a field to set 
your callback URL, and it doesn't let you point to localhost. So if you initiate
an auth request to twitter.com from localhost, and it callsback to 127.0.0.1,
it comes up with an error "failed to find request token in session".

This shouldn't be a problem when deployed on an actual domain.

###Control flow

All routes are in app.js. The flow between requests is:

####/auth/google/start 

 calls passport.auth('google') 

####/auth/google/callback 

  user will request this when google.com is finished
  This has a passport.auth call as route middleware. If auth succeeds, 
  req.user will be set by passport. req.user.handle will be set to a temporary
  value. Code execution will continue on to the callback function specified in 
  the route handler for /auth/google/callback.

  At this point we check to see if the req.user._ISNEW flag is set. If not we 
  redirect to /auth/success. If the flag is set we have more work to do, we 
  continue to

####/auth/google/paperwork

  This renders jade template paperwork-google as a response. It passes a
  'suggestion' string containing a guess at our new users' handle. The user
  clicks a submit button to confirm this or submit something new. That posts to

####/auth/google/paperwork/verify

  which redirects to /auth/google/paperwork if the users' desired handle is in 
  use. If not it sets req.user.handle to the new handle and calls 
  req.logIn(req.user) to load the updated user from Passport's session store. 
  Then it redirects to 

####/auth/google/paperwork/done

  which simply serves up a confirmation page to the user.


You can make a local account with a username/password, log in with it, link a
new google account to it, log out, log in with the Google account, and it's the
same as logging in with the local account.
  
  
  
  
